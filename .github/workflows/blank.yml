name: Root SSH via Cloudflare

on:
  workflow_dispatch:

jobs:
  ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install SSH Server
        run: |
          sudo apt update
          sudo apt install -y openssh-server curl

      - name: Configure Root Login
        run: |
          sudo mkdir -p /var/run/sshd

          # Set root password
          echo "root:bexcodex" | sudo chpasswd

          # Enable root login + password auth
          sudo sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

          # Restart ssh
          sudo service ssh restart

      - name: Install Cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 \
          -o cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/

      - name: Start Cloudflare Tunnel
        env:
          TUNNEL_TOKEN: eyJhIjoiNTNiNGE2ZDEzNzFkZTU5YWZmODU2ZmQzYjhkZDBlZWUiLCJ0IjoiMzY0ZGY1NWQtMTVlNS00NDNkLTlmYjQtYTk5MjNjNDc5NTNiIiwicyI6Ik5HTTNNRFl5WkRRdE1qUTBaQzAwWXpWaUxUa3pPREl0TnpjM1lqSTJZek5qTldJMCJ9
        run: |
          cloudflared tunnel --no-autoupdate run --token $TUNNEL_TOKEN &
          echo "Root SSH is ready"
          tail -f /dev/null

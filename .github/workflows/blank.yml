name: VMess Server via Cloudflare

on:
  workflow_dispatch:

jobs:
  vmess-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Xray Core
        run: |
          echo "Installing Xray..."
          wget -q https://github.com/XTLS/Xray-core/releases/download/v1.8.4/Xray-linux-64.zip
          unzip -q Xray-linux-64.zip
          sudo mv xray /usr/local/bin/
          sudo mv geoip.dat /usr/local/bin/
          sudo mv geosite.dat /usr/local/bin/
          sudo chmod +x /usr/local/bin/xray
          echo "Xray installed."

      - name: Configure Xray & Start
        run: |
          UUID="e4b01794-d46e-4154-934c-28dc12735777"
          echo "::notice title=VMess UUID::UUID: $UUID"
          
          mkdir -p config
          cat <<EOF > config/config.json
          {
            "log": {
              "loglevel": "warning"
            },
            "inbounds": [
              {
                "port": 8080,
                "listen": "127.0.0.1",
                "protocol": "vmess",
                "settings": {
                  "clients": [
                    {
                      "id": "$UUID",
                      "alterId": 0
                    }
                  ]
                },
                "streamSettings": {
                  "network": "ws",
                  "wsSettings": {
                    "path": "/vmess"
                  }
                }
              }
            ],
            "outbounds": [
              {
                "protocol": "freedom",
                "settings": {}
              }
            ]
          }
          EOF
          
          nohup xray run -c config/config.json > xray.log 2>&1 &
          echo "Xray started on port 8080."
          sleep 2

      - name: Start Cloudflare Tunnel
        run: |
          # Install Cloudflared
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
          
          echo "Starting Tunnel..."
          # Hapus log lama kalau ada
          rm -f tunnel.log
          
          # Jalanin tunnel
          nohup cloudflared tunnel --url http://127.0.0.1:8080 > tunnel.log 2>&1 &
          
          # Loop nungguin URL SPESIFIK (Maksimal 60 detik)
          echo "Waiting for URL..."
          FOUND=0
          for i in {1..30}; do
            # Cek apakah ada string https://...trycloudflare.com
            if grep -q "https://[-a-zA-Z0-9]*\.trycloudflare\.com" tunnel.log; then
              FOUND=1
              break
            fi
            echo "Waiting... ($i)"
            sleep 2
          done
          
          if [ $FOUND -eq 1 ]; then
            # Ambil URL-nya
            TUNNEL_URL=$(grep -o 'https://[-a-zA-Z0-9]*\.trycloudflare\.com' tunnel.log | head -n 1)
            
            if [ -z "$TUNNEL_URL" ]; then
                echo "::error::URL ketemu di grep tapi variabel kosong. Cek log:"
                cat tunnel.log
                exit 1
            fi

            echo "::notice title=Cloudflare URL::Link: $TUNNEL_URL"
            echo "----------------------------------------"
            echo "SUCCESS! DETAILS:"
            echo "Host: (Ambil domain dari URL $TUNNEL_URL)"
            echo "UUID: e4b01794-d46e-4154-934c-28dc12735777"
            echo "Path: /vmess"
            echo "TLS: ON"
            echo "----------------------------------------"
          else
            echo "::error::Gagal dapet URL Cloudflare (Timeout). Ini isi log terakhir:"
            cat tunnel.log
            exit 1
          fi

      - name: Keep Alive
        run: |
          echo "Server is running..."
          while true; do sleep 300; done
